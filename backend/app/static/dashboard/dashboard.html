<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - DarkWhisper</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap');

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Quicksand', sans-serif;
  }

  body {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background: #000;
    overflow: hidden;
  }

  section {
    position: absolute;
    width: 100vw;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    gap: 2px;
    overflow: hidden;
  }

  section::before {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    background: linear-gradient(#000, #0f0, #000);
    animation: animate 5s linear infinite;
    z-index: 0;
  }

  @keyframes animate {
    0% { transform: translateY(-100%); }
    100% { transform: translateY(100%); }
  }

  section span {
    position: relative;
    display: block;
    width: calc(6.25vw - 2px);
    height: calc(6.25vw - 2px);
    background: #181818;
    z-index: 2;
    transition: background 0.3s ease;
  }

  section span:hover {
    background: #0f0;
    transition: none;
  }

  .dashboard {
    position: absolute;
    width: 500px;
    background: rgba(34, 34, 34, 0.8);
    backdrop-filter: blur(10px);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 40px;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.8);
    color: #0f0;
    text-align: center;
  }

  .dashboard h1 {
    margin-bottom: 20px;
    font-size: 2em;
  }

  .dashboard p {
    margin: 10px 0;
    font-size: 1.2em;
    color: #fff;
  }

  .dashboard .link-box {
    background: #111;
    color: #0f0;
    padding: 10px 20px;
    border-radius: 6px;
    word-break: break-word;
    margin-top: 15px;
  }

  .chat-btn, .request-btn {
    background: #0f0;
    border: none;
    color: #000;
    padding: 10px 20px;
    font-size: 1em;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.3s ease;
    margin-top: 15px;
  }

  .chat-btn:hover, .request-btn:hover {
    background: #0a0;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
  }

  .modal-content {
    background: rgba(30, 30, 30, 0.9);
    margin: 10% auto;
    padding: 20px;
    border: 1px solid #0f0;
    width: 80%;
    max-width: 600px;
    border-radius: 10px;
    color: #0f0;
  }

.close {
  position: absolute;
  top: 10px;
  right: 15px;
  width: 28px;
  height: 28px;
  line-height: 28px;
  text-align: center;
  border-radius: 50%;
  background-color: transparent;
  color: #aaa;
  font-size: 20px;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.2s ease, color 0.2s ease;
}

.close:hover {
  background-color: rgba(255, 255, 255, 0.1);
  color: #fff;
}


  .request-item {
    background: #111;
    margin: 10px 0;
    padding: 15px;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .request-message {
    color: #fff;
  }

  .request-actions button {
    margin-right: 10px;
    padding: 6px 12px;
    font-weight: bold;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  .accept-btn {
    background-color: #0f0;
    color: #000;
  }

  .reject-btn {
    background-color: #f00;
    color: #fff;
  }

  @media (max-width: 600px) {
    section span {
      width: calc(20vw - 2px);
      height: calc(20vw - 2px);
    }

    .dashboard {
      width: 90%;
      padding: 20px;
    }
  }

      .tabs {
      display: flex;
      margin-bottom: 20px;
    }

    .tabs button {
      padding: 10px 20px;
      font-size: 1em;
      border: none;
      background: #222;
      color: #fff;
      cursor: pointer;
      border-radius: 6px;
      margin-right: 10px;
    }

    .tabs button.active {
      background: #0f0;
    }

    .tab-content {
      display: none;
      margin-top: 20px;
    }

    .tab-content.active {
      display: block;
    }
</style>

</head>
<body>
<section>

    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>




    <div class="dashboard">
      <h1 id="username">Welcome, User</h1>
      <p>Your invite link:</p>
      <div class="link-box" id="invite-link">
        Loading...
      </div>

      <!-- Buttons -->
      <div style="display: flex; gap: 15px; margin-top: 25px;">
        <button class="request-btn" onclick="openModal()">Requests</button>
        <button class="chat-btn">Chat Room</button>
      </div>
    </div>

    <!-- Modal -->
    <div id="requestModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Incoming Requests</h2>

        <!-- Tabs -->
        <div class="tabs">
          <button id="send-tab" class="active" onclick="switchTab('send')">Send Request</button>
          <button id="receive-tab" onclick="switchTab('receive')">Receive Request</button>
          <button id="history-tab" onclick="switchTab('history')">Request History</button>
        </div>

        <!-- Tab Contents -->
        <div id="send-tab-content" class="tab-content">
          <div style="display: flex; flex-direction: column; gap: 15px;">
            <input
              type="text"
              id="receiverIdInput"
              placeholder="Enter Receiver ID"
              style="padding: 10px; border: none; border-radius: 6px; background: #111; color: #0f0; font-size: 1em;"
            />
            <textarea
              id="messageInput"
              placeholder="Enter your message"
              rows="4"
              style="padding: 10px; border: none; border-radius: 6px; background: #111; color: #0f0; font-size: 1em; resize: none;"
            ></textarea>
            <button
              onclick="sendChatRequest()"
              style="background: #0f0; color: #000; padding: 10px 20px; font-size: 1em; font-weight: bold; border: none; border-radius: 6px; cursor: pointer;"
            >
              Send Request
            </button>
          </div>
        </div>


        <div id="receive-tab-content" class="tab-content active">
          <!-- Content for Receive Request goes here -->
          <div id="requestList"></div>
        </div>

        <div id="history-tab-content" class="tab-content">
          <!-- Request history will be injected here -->
          <div id="historyList"></div>
        </div>

        </div>
      </div>
    </div>


    
  </section>

  <script>

async function fetchUserData() {
  try {
    const response = await fetch('/me', { 
  method: 'GET',
  credentials: 'include', // Include cookies in requests
})


    if (!response.ok) {
      throw new Error(`Failed to fetch user data: ${response.status}`);
    }

    const data = await response.json();

    // Extract and use data
    const username = data.username;
    const nodeAddress = data.node_address;

    // Update UI
    document.getElementById('username').textContent = `Welcome, ${username}`;
    document.getElementById('invite-link').textContent =
      `http://127.0.0.1:8000/chat/request/${nodeAddress}`;

  } catch (error) {
    console.error('Error fetching user data:', error);
  }
}

// Call this function after the page loads
fetchUserData();

  
function switchTab(tabName) {
  // Remove active class from all tabs and content
  document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));

  // Add active class to selected tab
  document.getElementById(`${tabName}-tab`).classList.add('active');
  document.getElementById(`${tabName}-tab-content`).classList.add('active');

  // Load relevant data
  if (tabName === 'receive') {
    loadRequests();
  } else if (tabName === 'history') {
    loadHistory();
  }
}



async function sendChatRequest() {
  const receiverNode = document.getElementById('receiverIdInput').value.trim();
  const message = document.getElementById('messageInput').value.trim();

  if (!receiverNode || !message) {
    alert('Please fill in both Receiver ID and Message.');
    return;
  }

  try {
    const response = await fetch('http://127.0.0.1:8000/chat/request', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify({
        receiver_node: receiverNode,
        message: message
      })
    });

    if (!response.ok) {
      throw new Error(`Request failed with status ${response.status}`);
    }

    const data = await response.json();
    alert('Request sent successfully!');
    
    // Optionally clear inputs
    document.getElementById('receiverIdInput').value = '';
    document.getElementById('messageInput').value = '';

  } catch (error) {
    console.error('Error sending request:', error);
    alert('Failed to send request. Please try again.');
  }
}



async function fetchRequests() {
  try {
    const response = await fetch('http://127.0.0.1:8000/chat/requests', {
      method: 'GET',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include'
    });

    if (!response.ok) {
      throw new Error('Failed to fetch requests');
    }

    const data = await response.json();
    return data;
  } catch (error) {
    console.error('Error fetching requests:', error);
    return [];
  }
}

async function loadRequests() {
  const requestList = document.getElementById("requestList");
  requestList.innerHTML = ""; // Clear old content

  const requests = await fetchRequests(); // Fetch real requests

  if (requests.length === 0) {
    requestList.innerHTML = "<p>No requests found.</p>";
    return;
  }

  requests.forEach(req => {
    const item = document.createElement("div");
    item.className = "request-item";
    item.innerHTML = `
      <div class="request-message"><strong>From:</strong> ${formatSenderNode(req.sender_node)}<br>
      <strong>Message:</strong> ${req.message}</div>
      <div class="request-actions">
        <button class="accept-btn" onclick="handleAccept(${req.id})">Accept</button>
        <button class="reject-btn" onclick="handleReject(${req.id})">Reject</button>
      </div>
    `;
    requestList.appendChild(item);
  });
}


async function fetchHistory() {
  try {
    const response = await fetch('http://127.0.0.1:8000/chat/requests/history', {
      method: 'GET',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include'
    });

    if (!response.ok) {
      throw new Error('Failed to fetch request history');
    }

    const historyData = await response.json();
    return historyData;
  } catch (error) {
    console.error('Error fetching request history:', error);
    return [];
  }
}


async function loadHistory() {
  const container = document.getElementById('historyList');
  container.innerHTML = ''; // Clear previous entries

  const history = await fetchHistory();

  if (history.length === 0) {
    container.innerHTML = '<p>No request history available.</p>';
    return;
  }

  const list = document.createElement('div');
  list.style.display = 'flex';
  list.style.flexDirection = 'column';
  list.style.gap = '10px';

  history.forEach(item => {
    const entry = document.createElement('div');
    entry.style.border = '1px solid #444';
    entry.style.borderRadius = '8px';
    entry.style.padding = '10px';
    entry.style.background = '#111';
    entry.style.color = '#0f0';
    entry.innerHTML = `
      <p><strong>Address:</strong> ${formatSenderNode(item.address)}</p>
      <p><strong>Type:</strong> ${item.type === 'send' ? 'Sent' : 'Received'}</p>
      <p><strong>Status:</strong> ${item.status}</p>
    `;
    list.appendChild(entry);
  });

  container.appendChild(list);
}



function formatSenderNode(node) {
  const firstPart = node.slice(0, 10);  // First 10 characters
  const lastPart = node.slice(-7);      // Last 7 characters
  return `${firstPart}...${lastPart}`;  // Concatenate with "..."
}

function handleAccept(requestId) {
  // Handle request acceptance logic here
  console.log(`Accepted request with ID: ${requestId}`);
}

function handleReject(requestId) {
  // Handle request rejection logic here
  console.log(`Rejected request with ID: ${requestId}`);
}

function openModal() {
  document.getElementById('requestModal').style.display = 'block';
}

function closeModal() {
  document.getElementById('requestModal').style.display = 'none';
}


  </script>
</body>
</html>
